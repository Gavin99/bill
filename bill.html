<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>对账表</title>

    <!-- layui CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.9.7/dist/css/layui.css">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/layui@2.9.7/dist/layui.js"></script>
<div style="width: 800px;margin: auto;">
    <table class="layui-hide" id="bill-data"></table>
    <script type="text/html" id="toolbarBox">
        <h2 style="text-align: center;color: #1e9fff;padding: 3px;">对账表</h2>
    </script>
</div>
<script>
    var dataList = [ // 赋值已知数据
        {"id": "1", "name": "米", "price": "0", "qty": "1", "unit": "包", "total": "0"},
        {"id": "2", "name": "油", "price": "0", "qty": "1", "unit": "瓶", "total": "0"},
        {"id": "3", "name": "盐", "price": "0", "qty": "1", "unit": "包", "total": "0"},
        {"id": "4", "name": "生抽", "price": "0", "qty": "1", "unit": "瓶", "total": "0"},
        {"id": "5", "name": "老抽", "price": "0", "qty": "1", "unit": "瓶", "total": "0"},
        {"id": "6", "name": "醋", "price": "0", "qty": "1", "unit": "瓶", "total": "0"},
        {"id": "7", "name": "茶", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "8", "name": "鸡", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "9", "name": "鸭", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "10", "name": "鹅", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "11", "name": "鱼", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "12", "name": "猪肉", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "13", "name": "豆腐", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "14", "name": "香芋", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "15", "name": "白菜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "16", "name": "酸菜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "17", "name": "包菜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "18", "name": "香菜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "19", "name": "葱", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "20", "name": "蒜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "21", "name": "姜", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "22", "name": "青椒", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "23", "name": "小尖椒", "price": "0", "qty": "1", "unit": "斤", "total": "0"},
        {"id": "24", "name": "白酒", "price": "0", "qty": "1", "unit": "箱", "total": "0"},
        {"id": "25", "name": "啤酒", "price": "0", "qty": "1", "unit": "箱", "total": "0"},
        {"id": "26", "name": "橙汁", "price": "0", "qty": "1", "unit": "箱/瓶", "total": "0"},
        {"id": "27", "name": "椰汁", "price": "0", "qty": "1", "unit": "箱/瓶", "total": "0"},
        {"id": "28", "name": "可乐", "price": "0", "qty": "1", "unit": "箱/瓶", "total": "0"},
        {"id": "29", "name": "雪碧", "price": "0", "qty": "1", "unit": "箱/瓶", "total": "0"},
        {"id": "30", "name": "碗", "price": "0", "qty": "1", "unit": "打/箱", "total": "0"},
        {"id": "31", "name": "筷子", "price": "0", "qty": "1", "unit": "包/捆", "total": "0"},
    ];
    layui.use('table', function(){
        var table = layui.table;
        var util = layui.util;

        // 已知数据渲染
        var inst = table.render({
            elem: '#bill-data',
            cols: [[ //标题栏
                {field: 'id', title: '序号', width: 80, sort: true},
                {field: 'name', title: '名称', width: 120, sort: true},
                {field: 'price', title: '价格', sort: true, edit: 'text'},
                {field: 'qty', title: '数量', width: 80, edit: 'text'},
                {field: 'unit', title: '单位', edit: 'text', totalRow: '<b>总计:</b>'},
                {field: 'total', title: '总价',  sort: true, edit: 'text',totalRow: '<b id="subtotal">{{= parseInt(d.TOTAL_NUMS) }}</b>'}
            ]],
            data: dataList,
            css: [
                // 对开启了编辑的单元格追加样式
                '.layui-table-view td[data-edit]{color: #223a75;}'
            ].join(''),
            toolbar: '#toolbarBox',
            defaultToolbar: true,
            "totalRow": true,
            page: true, // 是否显示分页
            limits: [20, 50, 60,80,100],
            limit: 50 // 每页默认显示的数量
        });

        // 单元格编辑后的事件
        table.on('edit(bill-data)', function(obj){
            var field = obj.field;
            var value = obj.value;
            var data  = obj.data;

            if(field === 'total' || field === 'unit'){
                return;
            }

            if(value.replace(/\s/g, '') === ''){
                layer.tips('值不能为空', this, {tips: 1});
                return obj.reedit();
            }

            var price = parseFloat(data.price) || 0;
            var qty   = parseFloat(data.qty) || 0;

            // 1️⃣ 计算当前行 total
            var total = (price * qty).toFixed(2);

            // 2️⃣ 更新当前行（关键修复点）
            obj.update({
                total: total
            });

            // 3️⃣ 重新计算 subtotal
            var tableData = table.cache['bill-data'];
            var subtotal = 0;

            tableData.forEach(function(row){
                subtotal += parseFloat(row.total) || 0;
            });

            // 4️⃣ 更新底部合计
            $('.layui-table-total td[data-field="total"] .layui-table-cell')
                .html('<b>' + subtotal.toFixed(2) + '</b>');
        });
    });
</script>

</body>
</html>